{"version":3,"file":"valkyrie.global.js","sources":["../src/components/App.vue","../src/components/App.vue?vue&type=template&id=617ab0be&lang.js","../src/store/modules/worker.js","../src/store/modules/emitter.js","../src/store/index.js","../src/main.js"],"sourcesContent":["<template>\n  <div>{{ msg }}</div>\n</template>\n\n<script>\n\nexport default {\n  data() {\n    return {\n      msg: \"Hello world.\",\n    }\n  },\n}\n</script>\n","<template>\n  <div>{{ msg }}</div>\n</template>\n\n<script>\n\nexport default {\n  data() {\n    return {\n      msg: \"Hello world.\",\n    }\n  },\n}\n</script>\n","import content from \"./worker/content.js\"\n\nconst state = () => ({\n  worker: null, // 子线程 Worker 对象\n  socket: {     // 伪 WebSocket 中间件\n    readyState: 0,\n    onopen: () => {},\n    onclose: () => {},\n    onerror: () => {},\n    onmessage: () => {},\n  },\n})\nconst getters = {}\nconst mutations = {\n  initWorker(state) {\n    console.log(\"initWorker\")\n    state.worker = new Worker(URL.createObjectURL(new Blob([content])))\n  },\n}\nconst actions = {\n  initWebSocket({ state, getters, commit, dispatch }) {\n    console.log(\"initWebSocket\")\n\n    // 重写全局 WebSocket 类\n    unsafeWindow.WebSocket = function(uri) {\n      state.worker.postMessage({ type: \"create\", args: [uri] })\n    }\n    unsafeWindow.WebSocket.prototype = {\n      set onopen(fn) {\n        state.socket.onopen = fn\n      },\n      set onclose(fn) {\n        state.socket.onclose = fn\n      },\n      set onerror(fn) {\n        state.socket.onerror = fn\n      },\n      set onmessage(fn) {\n        state.socket.onmessage = fn\n      },\n      get readyState() {\n        return state.socket.readyState\n      },\n      send(command) {\n        dispatch(\"sendCommand\", command)\n      },\n    }\n  },\n  initWebWorker({ state, getters, commit, dispatch }) {\n    console.log(\"initWebWorker\")\n    state.worker.onmessage = event => {\n      const type = event.data.type\n      const args = event.data.args\n      // 处理函数集合\n      const handlers = {\n        onopen: event => state.socket.onopen(event),\n        onclose: event => state.socket.onclose(event),\n        onerror: event => state.socket.onerror(event),\n        onmessage: event => {\n          const data = eventToData(event)\n          dispatch(\"onData\", data)\n        },\n        readyState: value => (state.socket.readyState = value),\n      }\n      try {\n        handlers[type](...args)\n      } catch (error) {\n        console.log(type)\n        console.log(...args)\n        console.error(error)\n      }\n    }\n  },\n  init({ state, getters, commit, dispatch }) {\n    commit(\"initWorker\")\n    dispatch(\"initWebSocket\")\n    dispatch(\"initWebWorker\")\n  },\n  sendCommand({ state, getters, commit, dispatch }, command) {\n    state.worker.postMessage({ type: \"sendCommand\", args: [command] })\n    dispatch(\"onData\", { type: \"sendCommand\", command })\n  },\n  sendCommands({ state, getters, commit, dispatch }, ...args) {\n    state.worker.postMessage({ type: \"sendCommands\", args })\n    dispatch(\"onData\", { type: \"sendCommands\", args })\n  },\n  stopCommands({ state, getters, commit, dispatch }) {\n    state.worker.postMessage({ type: \"stopCommands\" })\n    dispatch(\"onData\", { type: \"stopCommands\" })\n  },\n  // 接收 Worker 线程中的 WebSocket 的 data 数据\n  onData({ state, getters, commit, dispatch }, data) {\n    console.log(data)\n    // 触发事件\n    const type = data.dialog || data.type || \"type\"\n    dispatch(\"emitter/emit\", { type, data }, { root: true })\n    // 返回至 socket.onmessage 中处理\n    const event = dataToEvent(data)\n    state.socket.onmessage(event)\n  },\n  onText({ state, getters, commit, dispatch }, text) {\n    dispatch(\"onData\", { type: \"text\", text })\n  },\n}\n\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  actions,\n  mutations,\n}\n\nfunction eventToData(event) {\n  const data = event.data\n  if (typeof data === \"string\" && data[0] === \"{\") {\n    try {\n      return new Function(`return ${ data };`)()\n    } catch (error) {}\n  }\n  return { type: \"text\", text: data }\n}\nfunction dataToEvent(data) {\n  if (data.type === \"text\") {\n    return { data: data.text }\n  }\n  return { data: JSON.stringify(data) }\n}\n","export default {\n  namespaced: true,\n  state() {\n    return {\n      id: 0,\n      types: {},\n      handlers: {},\n    }\n  },\n  mutations: {\n    addHandler(state, { type, handler }) {\n      const handlerId = (++ state.id)\n      if (Array.isArray(state.types[type]) === false) {\n        state.types[type] = []\n      }\n      const typeIndex = state.types[type].length\n      state.types[type].push(handlerId)\n      state.handlers[handlerId] = { type, typeIndex, handler, handlerId }\n    },\n    deleteHandler(state, id) {\n      const { type, typeIndex, handler, handlerId } = state.handlers[id]\n      delete state.handlers[handlerId]\n      delete state.types[type][typeIndex]\n    },\n  },\n  actions: {\n    emit({ state, commit }, { type, data }) {\n      const ids = state.types[type]\n      if (Array.isArray(ids) === false) return\n      ids.forEach(id => {\n        if (id === undefined) return\n        const { handler, handlerId } = state.handlers[id]\n        if (typeof handler === \"function\") {\n          // 第二个参数为注销自身的方法\n          handler(data, () => commit(\"deleteHandler\", handlerId))\n        }\n      })\n    },\n    on({ state, commit }, { type, handler }) {\n      commit(\"addHandler\", { type, handler })\n      // 返回一个注销自身的方法\n      return () => commit(\"deleteHandler\", state.id)\n    },\n  },\n}\n","import { createStore } from \"vuex\"\n\nimport worker from \"./modules/worker\"\nimport emitter from \"./modules/emitter\"\n\nconst store = createStore({\n  state() {\n    return {}\n  },\n  mutations: {},\n  actions: {},\n  modules: {\n    worker,\n    emitter,\n  }\n})\n\nexport default store\n","import { createApp } from \"vue\"\nimport App from \"./components/App.vue\"\n\nimport store from \"./store\"\n\nconst app = createApp(App)\napp.use(store)\nstore.dispatch(\"worker/init\")\n\n// DOM 加载完毕\ndocument.addEventListener(\"DOMContentLoaded\", function() {\n  console.log(\"DOMContentLoaded\")\n\n  // document.head.insertAdjacentHTML(`beforeend`, HeadHTML)\n  // css\n  // document.head.insertAdjacentHTML(`beforeend`, `<style>${ValkyrieStyle}</style>`)\n  // body\n  document.body.insertAdjacentHTML(`beforeend`, `<div id=\"app\"></div>`)\n  // room\n  // document.querySelector(`.map-panel`).remove()\n  // document.querySelector(`.room-title`).remove()\n  // document.querySelector(`.room_desc`).remove()\n  // document.querySelector(`.content-room`).insertAdjacentHTML(`afterbegin`, `<div id=\"app-room\"></div>`)\n  // 挂载 Valkyrie\n  unsafeWindow.Valkyrie = app.mount(`#app`)\n})\n\n\n"],"names":["_createBlock","createStore","createApp","App"],"mappings":"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"}