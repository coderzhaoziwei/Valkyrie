{"version":3,"file":"valkyrie.cjs.js","sources":["../src/components/App.vue","../src/components/App.vue?vue&type=template&id=617ab0be&lang.js","../src/store/modules/worker.js","../src/store/modules/emitter.js","../src/store/index.js","../src/main.js"],"sourcesContent":["<template>\n  <div>{{ msg }}</div>\n</template>\n\n<script>\n\nexport default {\n  data() {\n    return {\n      msg: \"Hello world.\",\n    }\n  },\n}\n</script>\n","<template>\n  <div>{{ msg }}</div>\n</template>\n\n<script>\n\nexport default {\n  data() {\n    return {\n      msg: \"Hello world.\",\n    }\n  },\n}\n</script>\n","import content from \"./worker/content.js\"\n\nconst state = () => ({\n  worker: null, // 子线程 Worker 对象\n  socket: {     // 伪 WebSocket 中间件\n    readyState: 0,\n    onopen: () => {},\n    onclose: () => {},\n    onerror: () => {},\n    onmessage: () => {},\n  },\n})\nconst getters = {}\nconst mutations = {\n  initWorker(state) {\n    console.log(\"initWorker\")\n    state.worker = new Worker(URL.createObjectURL(new Blob([content])))\n  },\n}\nconst actions = {\n  initWebSocket({ state, getters, commit, dispatch }) {\n    console.log(\"initWebSocket\")\n\n    // 重写全局 WebSocket 类\n    unsafeWindow.WebSocket = function(uri) {\n      state.worker.postMessage({ type: \"create\", args: [uri] })\n    }\n    unsafeWindow.WebSocket.prototype = {\n      set onopen(fn) {\n        state.socket.onopen = fn\n      },\n      set onclose(fn) {\n        state.socket.onclose = fn\n      },\n      set onerror(fn) {\n        state.socket.onerror = fn\n      },\n      set onmessage(fn) {\n        state.socket.onmessage = fn\n      },\n      get readyState() {\n        return state.socket.readyState\n      },\n      send(command) {\n        dispatch(\"sendCommand\", command)\n      },\n    }\n  },\n  initWebWorker({ state, getters, commit, dispatch }) {\n    console.log(\"initWebWorker\")\n    state.worker.onmessage = event => {\n      const type = event.data.type\n      const args = event.data.args\n      // 处理函数集合\n      const handlers = {\n        onopen: event => state.socket.onopen(event),\n        onclose: event => state.socket.onclose(event),\n        onerror: event => state.socket.onerror(event),\n        onmessage: event => {\n          const data = eventToData(event)\n          dispatch(\"onData\", data)\n        },\n        readyState: value => (state.socket.readyState = value),\n      }\n      try {\n        handlers[type](...args)\n      } catch (error) {\n        console.log(type)\n        console.log(...args)\n        console.error(error)\n      }\n    }\n  },\n  init({ state, getters, commit, dispatch }) {\n    commit(\"initWorker\")\n    dispatch(\"initWebSocket\")\n    dispatch(\"initWebWorker\")\n  },\n  sendCommand({ state, getters, commit, dispatch }, command) {\n    state.worker.postMessage({ type: \"sendCommand\", args: [command] })\n    dispatch(\"onData\", { type: \"sendCommand\", command })\n  },\n  sendCommands({ state, getters, commit, dispatch }, ...args) {\n    state.worker.postMessage({ type: \"sendCommands\", args })\n    dispatch(\"onData\", { type: \"sendCommands\", args })\n  },\n  stopCommands({ state, getters, commit, dispatch }) {\n    state.worker.postMessage({ type: \"stopCommands\" })\n    dispatch(\"onData\", { type: \"stopCommands\" })\n  },\n  // 接收 Worker 线程中的 WebSocket 的 data 数据\n  onData({ state, getters, commit, dispatch }, data) {\n    console.log(data)\n    // 触发事件\n    const type = data.dialog || data.type || \"type\"\n    dispatch(\"emitter/emit\", { type, data }, { root: true })\n    // 返回至 socket.onmessage 中处理\n    const event = dataToEvent(data)\n    state.socket.onmessage(event)\n  },\n  onText({ state, getters, commit, dispatch }, text) {\n    dispatch(\"onData\", { type: \"text\", text })\n  },\n}\n\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  actions,\n  mutations,\n}\n\nfunction eventToData(event) {\n  const data = event.data\n  if (typeof data === \"string\" && data[0] === \"{\") {\n    try {\n      return new Function(`return ${ data };`)()\n    } catch (error) {}\n  }\n  return { type: \"text\", text: data }\n}\nfunction dataToEvent(data) {\n  if (data.type === \"text\") {\n    return { data: data.text }\n  }\n  return { data: JSON.stringify(data) }\n}\n","export default {\n  namespaced: true,\n  state() {\n    return {\n      id: 0,\n      types: {},\n      handlers: {},\n    }\n  },\n  mutations: {\n    addHandler(state, { type, handler }) {\n      const handlerId = (++ state.id)\n      if (Array.isArray(state.types[type]) === false) {\n        state.types[type] = []\n      }\n      const typeIndex = state.types[type].length\n      state.types[type].push(handlerId)\n      state.handlers[handlerId] = { type, typeIndex, handler, handlerId }\n    },\n    deleteHandler(state, id) {\n      const { type, typeIndex, handler, handlerId } = state.handlers[id]\n      delete state.handlers[handlerId]\n      delete state.types[type][typeIndex]\n    },\n  },\n  actions: {\n    emit({ state, commit }, { type, data }) {\n      const ids = state.types[type]\n      if (Array.isArray(ids) === false) return\n      ids.forEach(id => {\n        if (id === undefined) return\n        const { handler, handlerId } = state.handlers[id]\n        if (typeof handler === \"function\") {\n          // 第二个参数为注销自身的方法\n          handler(data, () => commit(\"deleteHandler\", handlerId))\n        }\n      })\n    },\n    on({ state, commit }, { type, handler }) {\n      commit(\"addHandler\", { type, handler })\n      // 返回一个注销自身的方法\n      return () => commit(\"deleteHandler\", state.id)\n    },\n  },\n}\n","import { createStore } from \"vuex\"\n\nimport worker from \"./modules/worker\"\nimport emitter from \"./modules/emitter\"\n\nconst store = createStore({\n  state() {\n    return {}\n  },\n  mutations: {},\n  actions: {},\n  modules: {\n    worker,\n    emitter,\n  }\n})\n\nexport default store\n","import { createApp } from \"vue\"\nimport App from \"./components/App.vue\"\n\nimport store from \"./store\"\n\nconst app = createApp(App)\napp.use(store)\nstore.dispatch(\"worker/init\")\n\n// DOM 加载完毕\ndocument.addEventListener(\"DOMContentLoaded\", function() {\n  console.log(\"DOMContentLoaded\")\n\n  // document.head.insertAdjacentHTML(`beforeend`, HeadHTML)\n  // css\n  // document.head.insertAdjacentHTML(`beforeend`, `<style>${ValkyrieStyle}</style>`)\n  // body\n  document.body.insertAdjacentHTML(`beforeend`, `<div id=\"app\"></div>`)\n  // room\n  // document.querySelector(`.map-panel`).remove()\n  // document.querySelector(`.room-title`).remove()\n  // document.querySelector(`.room_desc`).remove()\n  // document.querySelector(`.content-room`).insertAdjacentHTML(`afterbegin`, `<div id=\"app-room\"></div>`)\n  // 挂载 Valkyrie\n  unsafeWindow.Valkyrie = app.mount(`#app`)\n})\n\n\n"],"names":["_createBlock","createStore","createApp","App"],"mappings":"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"}